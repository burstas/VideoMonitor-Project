
<!DOCTYPE html>
<html lang="en">

<head>
    <title>@ViewBag.Title</title>

    <!-- for Edige/FF/Chrome/Opera/etc. getUserMedia support -->
    <script src="~/Content/mobile/gumadapter.js"></script>
    <link href="~/Content/bootstrap.css" rel="stylesheet" />
    <link href="~/Content/mobile/videoRecorder.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-1.10.2.min.js"></script>
    <script src="~/Scripts/bootstrap.js"></script>

    <script src="~/Content/mobile/videoRecorder.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=A4BeW8fh7eQvAsUwn5IGwzd0grc89KyQ"></script>
    

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    @RenderSection("header")

</head>

<body>
    <header>
        <form class="form-inline" action="/" method="post">
            <div class="form-group" style="padding-top:.2rem">
                
                <!-- Split button -->
                <div class="dropdown" style="float:left" >

                    <button type="button" class="btn btn-success dropdown-toggle main-title" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        验厂<span class="caret"></span>
                        <span class="sr-only"></span>
                    </button>
                    <ul class="dropdown-menu select-menu">

                        <li><a href="/video/ValidateRecorder" data-value="13">工厂大门</a></li>
                        <li><a href="/video/ValidateRecorder" data-value="14">原材料</a></li>
                        <li><a href="/video/ValidateRecorder" data-value="15">半成品 </a></li>
                        <li><a href="/video/ValidateRecorder" data-value="16">成品 </a></li>
                        <li><a href="/video/ValidateRecorder" data-value="17">生产车间</a></li>
                        <li><a href="/video/ValidateRecorder" data-value="18">办公室</a></li>
                        <li><a href="/video/ValidateRecorder" data-value="19">机器设备</a></li>
                    </ul>
                </div>
                <!-- Split button -->
                <div class="dropdown" style="float:left">

                    <button type="button" class="btn btn-info dropdown-toggle main-title" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        监装<span class="caret"></span>
                        <span class="sr-only"></span>
                    </button>
                    <ul class="dropdown-menu select-menu">

                        <li><a href="/video/MonitorRecorder" data-value="8">工厂大门</a></li>
                        <li><a href="/video/MonitorRecorder" data-value="9">装货中</a></li>
                        <li><a href="/video/MonitorRecorder" data-value="10">装满柜 </a></li>

                        <li><a href="/video/MonitorRecorder" data-value="11">半关门（含箱号）</a></li>
                        <li><a href="/video/MonitorRecorder" data-value="12">外箱包装</a></li>

                    </ul>
                </div>
                <!-- Split button -->
                <div class="dropdown" style="float:left">

                    <button type="button" class="btn btn-warning dropdown-toggle main-title" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        签约<span class="caret"></span>
                        <span class="sr-only"></span>
                    </button>
                    <ul class="dropdown-menu select-menu">

                        <li><a href="/video/ContractRecorder" data-value="20">签约中</a></li>

                    </ul>
                </div>
                <div class="dropdown" style="float:left">

                    <button type="button" class="btn btn-danger dropdown-toggle main-title" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        验货<span class="caret"></span>
                        <span class="sr-only"></span>
                    </button>
                    <ul class="dropdown-menu select-menu">

                        <li><a href="/video/InspectGoodsRecorder" data-value="21">验货地</a></li>
                        <li><a href="/video/InspectGoodsRecorder" data-value="22">外箱包装</a></li>
                        <li><a href="/video/InspectGoodsRecorder" data-value="23">产品 </a></li>

                    </ul>
                </div>


                @*<a class="btn btn-default" style="float:right" href="/user/info">个人信息</a>*@
                <div class="dropdown" style="float:right">
                    <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        ...&nbsp;&nbsp;&nbsp;
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" style="right:0px" aria-labelledby="dropdownMenu1">
                        <li><a href="/user/info">个人信息</a></li>
                        <li><a href="/user/Logout">退出登录</a></li>
                    </ul>
                </div>
 
            </div>

        </form>
    </header>

    <div class="github-stargazers"></div>

    <section class="experiment" style="padding: 5px;">
        <div class="companyName"></div>
        <div class="form-group">
            <p style="text-align:center" class="select-tips"></p>
            <div class="btn-record">
                <a href="javascript:;" class="file btn btn-default">
                    开始录制
                    <input type="file" class="btn btn-danger" accept="video/*" name="select-file" id="select-file" value="" />
                </a>
            </div>
            <label id="fileName" class="col-sm-2 control-label"></label>

        </div>
        <div class="top-Box">
            @RenderBody()
        </div>
        <div class="form-group">

            <button id="save-recording" class="btn btn-danger">上传</button>
        </div>
    </section>
    <div id="maskBox" style="display:none">

    </div>

    <section class="progressSection hidden">
        <div class="progress">
            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                <span class="sr-only"></span>
            </div>


        </div>
        <div class="alert alert-danger" role="alert">视频正在上传，请勿进行其他操作！</div>
    </section>
    <section>
        <div class="alert alert-info hidden" role="alert">
        </div>
        <div class="alert alert-success hidden" role="alert"></div>

    </section>
    <section class="using-tips">
        <div class="alert alert-info">
            如果你使用的是安卓手机，请事先设置你的视频录制选项，或在录制节目设置，调节录像的分辨率设置最低，否则视频文件会很大，上传缓慢。
        </div>
    </section>
    <section>
        <!-- 模态框（Modal） -->
        <div style="width: 300px;margin: 30px auto;" class="modal fade bs-example-modal-sm" id="myModal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <h4 class="modal-title" id="myModalLabel">
                            提示
                        </h4>
                    </div>
                    <div class="modal-body">
                    </div>

                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
    </section>
    <div id="container" ></div> 
    <script type="text/javascript">
        var _address;
        var _lng;
        var _lat;
        var _location;
        // 百度地图API功能
        var map = new BMap.Map("container");
        var point = new BMap.Point(108.95, 34.27);
        map.centerAndZoom(point, 12);

        var geolocation = new BMap.Geolocation();
        geolocation.getCurrentPosition(function (r) {
            _location = r;
            console.log(r.point)
            if (this.getStatus() == BMAP_STATUS_SUCCESS) {
                var mk = new BMap.Marker(r.point);
                map.addOverlay(mk);//标出所在地
                map.panTo(r.point);//地图中心移动
                //alert('您的位置：'+r.point.lng+','+r.point.lat);
                var point = new BMap.Point(r.point.lng, r.point.lat);//用所定位的经纬度查找所在地省市街道等信息
                var gc = new BMap.Geocoder();
                gc.getLocation(point, function (rs) {
                    var addComp = rs.addressComponents; console.log(rs.address);//地址信息
                    //alert(rs.address);//弹出所在地址
                    //_address = rs.address;
                    baiduAddress = rs.addressComponents;
                    _address = baiduAddress.province + "," + baiduAddress.city + "," + baiduAddress.district + "," + baiduAddress.street + "," + baiduAddress.streetNumber;
                    _lng = r.point.lng;
                    _lat = r.point.lat;
                    //alert(_address);
                });
            } else {
                alert('failed' + this.getStatus());
            }
        }, { enableHighAccuracy: true })
    </script>
    <script type="text/javascript">

            var subType_ = getCookie_('subType_');
            var videoType_=@ViewBag.VideoType


            CheckUserInfo();//检查用户信息是否完善

            //--------------检查是否是 ios  和  Android
            var u = navigator.userAgent;
            var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
            var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
            //alert('是否是Android：' + isAndroid);
            //alert('是否是iOS：' + isiOS);



            document.querySelector('#maskBox').onclick = function () {
                CheckUserInfo();
            };

            document.querySelector('.file').onchange = function () {
                var file_ = document.getElementById("select-file").files[0];
                if (file_) {
                    document.querySelector('#fileName').innerHTML = file_.name;
                }
            }
            //当用户点击 切换录制类型和地点，把类型存入cookie，方便页面刷新或调整的数据传递。
            $('.select-menu li a').click(function () {
                setCookie('subType_', $(this).attr('data-value'));
                var _title = $(this).parent().parent().parent().find('.main-title').text();
                var _pageTitle = _title + '-' + $(this).text();
                setCookie('pageTitle_', _pageTitle)

            });

            document.querySelector('.btn-record').onclick = function () {
                if (subType_) {//用户是否选择地点

                }
                else {
                    msgBox('请选着录制地点！');
                    return false;

                }
                if (_location) {//是否获取到了地理位置
                    if (_location.accuracy){//用户是否拒绝授权地理位置

                    }
                    else {
                        msgBox('请刷新网页，允许授权访问位置！');
                        return false;
                    }
                }
                else {
                    msgBox('正在获取地理位置，请稍后。。。');
                    return false;
                }
                
            };
            document.querySelector('#save-recording').onclick =function () {
                var file_ = document.getElementById("select-file").files[0];
                if (file_) {//是否选择或录制的视频
                    //isAndroid = true;
                    if (isiOS) {//如果是iOS

                        var ext = getFileExt(file_.name);

                        if (ext != 'mov') {
                            msgBox('请选择正确的视频格式！');
                            return;
                        }

                        if (file_.name.indexOf("captured") > -1 || file_.name.indexOf("__") > -1) {//ios端 是否选着了 录制的视频

                            upload(file_);
                        }
                        else {
                            msgBox('请使用录制的视频上传！');
                            return;
                        }

                    }
                    else if (isAndroid) {//如果是 Android

                        var ext = getFileExt(file_.name);
                        if (ext != 'mp4') {
                            msgBox('请选择正确的视频格式！');
                            return;
                        }
                        if (file_.name.indexOf("wx") > -1 || file_.name.indexOf("WX") > -1
                            || file_.name.indexOf("QQ") > -1 || file_.name.indexOf("qq") > -1
                            || isNotANumber(file_.name)) {
                            msgBox('请使用录制的视频上传！');
                            return;
                        }
                        var now = new Date;
                        now.setSeconds(now.getSeconds() - 10);//当前时间前去10秒钟

                        if (file_.lastModifiedDate < now) {//如果视频时间 早于 当前时间10分钟以前
                            msgBox('视频已过期！请重新录制！');
                            return;
                        }
                        upload(file_);
                    }
                    else{
                        upload(file_);
                    }
                    

                }
                else {
                    msgBox("请先录制视频！");
                }

            };
            function upload(file_)
            {
                if (document.querySelector('#boxNum') != undefined) {//判断当前页面是 监装还是 验厂
                    var boxNum_ = document.querySelector('#boxNum').value;
                    $.get("/com/CheckBoxNumIsRight?boxNum=" + boxNum_, function (res) {
                        if (!res) {//如果是监装 判断 箱号是否正确
                            msgBox("请输入正确箱号");
                            return;
                        }
                        else {

                            uploadToDotNetServer(file_, videoType_, subType_, _address, _lng, _lat);
                        }
                    });
                }
                else {//如果不是监装 直接上传

                    uploadToDotNetServer(file_, videoType_, subType_, _address, _lng, _lat);

                }
            }

            //当页面加载时 cookie是否有 页面标题，如果有设置 网页title和下面提示问题
            var pageTitle_ = getCookie_('pageTitle_');
            if (pageTitle_) {
                document.title = pageTitle_;
                $('.select-tips').text(pageTitle_);
            }

            //当页面加载时 请求获取用户的公司名称， 设置页面下方提示文本
            $.post('/user/GetUserViewModelJsonAsync', function (data) {
                var company_ = data.CompanyName;
                $('.companyName').text(company_);
            });




    </script>

    <footer></footer>
</body>

</html>
